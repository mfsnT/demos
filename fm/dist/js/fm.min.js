$(function(){function i(i){this.$ct=i,this.songsArr=[],this.current_song_index=0,this.lyric_timeline=null,this.current_lyric_index=0,this.lyric_ct_scroll_height=0,this.shouldUpdate=!0,this.shouldScroll=!0,this.shouldPlayNextSong=!1,this.shouldShowTips=!1,this.init()}i.prototype={init:function(){var i=this.$ct;this.$cover=i.find(".cover img"),this.$singer=i.find(".singer"),this.$song_title=i.find(".song-title"),this.$lyric_ct=i.find(".lyric-ct"),this.$audio=i.find("audio"),this.$total_progress_bar=i.find(".total-progress-bar"),this.$play_progress_bar=i.find(".play-progress-bar"),this.$channel_btn=i.find(".channel a"),this.$channel_list=i.find(".channel-list"),this.channel_id=i.find(".channel-list-item").eq(0).attr("data-channel-id"),this.$prev_btn=i.find(".prev"),this.$play_btn=i.find(".play"),this.$next_btn=i.find(".next"),this.$vol_panel=i.find(".volume-panel"),this.$vol_btn=i.find(".volume a"),this.$tips=i.find(".tips"),this.bind()},bind:function(){function i(i){return"false"!==i.attr("data-isPlaying")}var t=this,n=this.$lyric_ct,e=this.$audio,l=this.$total_progress_bar,r=this.$play_progress_bar,s=this.$channel_btn,o=this.$channel_list,c=(o.children(),this.$prev_btn),h=this.$play_btn,a=h.children(),u=this.$next_btn,d=this.$vol_btn,g=this.$vol_panel,_=g.children(),p=_.children();e.on("timeupdate",function(){if(t.shouldUpdate){var i=Math.floor(this.currentTime/this.duration*100);r.width(i+"%"),t.shouldUpdate=!1,t.lyricScroll(this.currentTime),setTimeout(function(){t.shouldUpdate=!0},500)}}).on("playing",function(){a.removeClass("icon-play").addClass("icon-pause"),h.attr("data-isPlaying",!0)}).on("pause",function(){a.removeClass("icon-pause").addClass("icon-play"),h.attr("data-isPlaying",!1)}).on("ended",function(i){u.trigger("click",i)}),l.on("click",function(n){var l=0,s=n.offsetX/340*e[0].duration;e[0].currentTime=s;var o=Math.floor(s/e[0].duration*100);if(r.width(o+"%"),t.lyric_ct_scroll_height=0,i(h)||h.trigger("click",n),s>t.lyric_timeline[t.lyric_timeline.length-1])return t.current_lyric_index=t.lyric_timeline.length-1,void(t.lyric_ct_scroll_height=t.lyric_ct_total_height);for(;l<t.lyric_timeline.length;){if(s<t.lyric_timeline[l]){t.current_lyric_index=l-1;break}t.lyric_ct_scroll_height+=t.$lyric_collection.eq(l).outerHeight(!0)-10,l++}t.lyric_ct_scroll_height-=t.$lyric_collection.eq(l).outerHeight(!0)-10}),s.on("click",function(i){i.stopPropagation(),i.preventDefault(),o.show()}),$("body").on("click",function(){o.hide(),g.removeClass("show-volume-bar")}),o.on("click","li",function(){var i=$(this);i.index();i.hasClass("active-channel")||(t.channel_id=i.attr("data-channel-id"),i.addClass("active-channel").siblings().removeClass("active-channel"),t.getSong())}),c.on("click",function(i){if(i.preventDefault(),0!==t.current_song_index){var n=--t.current_song_index;t.render(t.songsArr[n]),t.playSong(t.songsArr[n].url)}else t.showTips("已经是最后一首歌曲了")}),h.on("click",function(t){t.preventDefault(),i($(this))?e[0].pause():e[0].play()}),u.on("click",function(i){if(i.preventDefault(),!t.shouldPlayNextSong){if(t.current_song_index+1<t.songsArr.length){var n=++t.current_song_index;return t.render(t.songsArr[n]),void t.playSong(t.songsArr[n].url)}t.shouldPlayNextSong=!0,t.getSong()}}),d.on("click",function(i){i.preventDefault(),i.stopPropagation(),_.toggleClass("show-volume-panel")}),_.on("click",function(i){var t=Math.floor(i.offsetX/150*100);t<0||(p.width(t+"%"),e[0].volume=t/100)}),n.on("mouseenter",function(){t.shouldScroll=!1}).on("mouseleave",function(){t.shouldScroll=!0})},getSong:function(){var i=this;$.get("https://jirenguapi.applinzi.com/fm/getSong.php",{channel:i.channel_id}).done(function(t){var n=i.getSongMsg(JSON.parse(t));null!==n.url?(i.songsArr.length>0&&i.current_song_index++,i.getLyric(n)):i.getSong()}).fail(function(){i.showTips("获取歌曲失败，请检查网络")})},getLyric:function(i){var t=this;$.get("https://jirenguapi.applinzi.com/fm/getLyric.php",{sid:i.sid}).done(function(n){i.lyric=JSON.parse(n).lyric,t.songsArr.push(i),t.render(i),t.playSong(i.url)}).fail(function(){i.lyric=null,t.showTips("获取歌词失败"),t.songsArr.push(i),t.render(i),t.playSong(i.url)})},getSongMsg:function(i){return{sid:i.song[0].sid,title:i.song[0].title,cover:i.song[0].picture,singer:i.song[0].artist,url:i.song[0].url}},playSong:function(i){this.$play_progress_bar.width(0),this.$audio[0].src=i,this.$audio[0].play()},render:function(i){var t='<p class="current-lyric">音乐来自百度FM, by 饥人谷</p>',n=0,e=0,l=[],r="",s=0,o=this;null!==i.lyric&&(i.lyric.split(/[\r\n]{1,2}/).filter(function(i){return!/^\[.+\]$/.test(i)}).forEach(function(i,o){n=i.lastIndexOf("]"),e=i.lastIndexOf("["),r=i.substr(e+1,8),/^\d{2}:\d{2}\.\d{2}$/.test(r)&&0!==(r=60*r[1]+ +(r[3]+r[4]))&&(r===s?t=t.substr(0,t.length-4)+"<br>"+i.substr(n+1)+"</p>":(s=r,l.push(r),t+="<p>"+i.substr(n+1)+"</p>"))}),0===l.length&&(t+="<p>该歌曲为无歌词</p>"),this.lyric_timeline=l,this.$lyric_ct.empty().append(t),this.$lyric_collection=this.$lyric_ct.children(),this.current_lyric_index=0,this.lyric_ct_total_height=function(){for(var i=0,t=0;t<o.$lyric_collection.length-2;t++)i+=o.$lyric_collection.eq(t).outerHeight(!0)-10;return i}()),this.$singer.text(i.singer),this.$cover[0].src=i.cover,this.$song_title.text(i.title),this.lyric_ct_scroll_height=0,this.$lyric_ct.animate({scrollTop:0}),this.shouldPlayNextSong=!1},showTips:function(i){var t=this.$tips,n=this;this.shouldShowTips||(this.shouldShowTips=!0,t.text(i).fadeIn(1e3).fadeOut(1e3,function(){n.shouldShowTips=!1}))},lyricScroll:function(i){var t=this,n=t.current_lyric_index,e=t.lyric_timeline,l=t.$lyric_collection.eq(n).outerHeight(!0)-10;e.length<=2||n<e.length&&e[n]<=i&&(t.lyric_ct_scroll_height+=l,t.$lyric_collection.eq(n+1).addClass("current-lyric").siblings().removeClass("current-lyric"),t.current_lyric_index++,t.shouldScroll&&t.$lyric_ct.animate({scrollTop:t.lyric_ct_scroll_height},1e3))}},{init:function(t){var n=null;t.each(function(){(n=new i($(this))).getSong()})}}.init($("#app"))});